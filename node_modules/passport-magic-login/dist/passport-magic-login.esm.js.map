{"version":3,"file":"passport-magic-login.esm.js","sources":["../src/token.ts","../src/index.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\n\ntype JwtPayload = {\n  destination: string;\n  code: string;\n  [key: string]: any;\n};\n\nexport const decodeToken = (secret: string, token?: string) => {\n  if (typeof token !== 'string') {\n    return false;\n  }\n  try {\n    return jwt.verify(token, secret) as JwtPayload;\n  } catch (err) {\n    return false;\n  }\n};\n\nexport const generateToken = (secret: string, payload: JwtPayload) =>\n  jwt.sign(payload, secret, {\n    expiresIn: '60min',\n  });\n","import { Request, Response } from 'express';\nimport { StrategyCreatedStatic } from 'passport';\nimport { generateToken, decodeToken } from './token';\n\ntype VerifyCallback = (\n  payload: any,\n  verifyCallback: (err?: Error, user?: Object, info?: any) => void\n) => void;\n\ninterface Options {\n  secret: string;\n  callbackUrl: string;\n  sendMagicLink: (\n    destination: string,\n    href: string,\n    verificationCode: string,\n    req: Request\n  ) => Promise<void>;\n  verify: VerifyCallback;\n\n  /** @deprecated */\n  confirmUrl?: string;\n}\n\nclass MagicLoginStrategy {\n  name: string = 'magiclogin';\n\n  constructor(private _options: Options) {}\n\n  authenticate(\n    this: StrategyCreatedStatic & MagicLoginStrategy,\n    req: Request\n  ): void {\n    const self = this;\n    const payload = decodeToken(\n      self._options.secret,\n      req.query.token as string\n    );\n\n    const verifyCallback = function(err?: Error, user?: Object, info?: any) {\n      if (err) {\n        return self.error(err);\n      } else if (!user) {\n        return self.fail(info);\n      } else {\n        return self.success(user, info);\n      }\n    };\n\n    self._options.verify(payload, verifyCallback);\n  }\n\n  send = (req: Request, res: Response): void => {\n    if (!req.body.destination) {\n      res.status(400).send('Please specify the destination.');\n      return;\n    }\n\n    const code = Math.floor(Math.random() * 90000) + 10000 + '';\n    const jwt = generateToken(this._options.secret, {\n      ...req.body,\n      code,\n    });\n\n    this._options\n      .sendMagicLink(\n        req.body.destination,\n        `${this._options.callbackUrl}?token=${jwt}`,\n        code,\n        req\n      )\n      .then(() => {\n        res.json({ success: true, code });\n      })\n      .catch((error: any) => {\n        console.error(error);\n        res.json({ success: false, error });\n      });\n  };\n\n  /** @deprecated */\n  confirm = (req: Request, res: Response): void => {\n    console.warn(\n      `magicLink.confirm was removed in v1.0.7, it is no longer necessary.`\n    );\n    res.redirect(`${this._options.callbackUrl}?token=${req.query.token}`);\n  };\n}\n\nexport default MagicLoginStrategy;\n"],"names":["decodeToken","secret","token","jwt","verify","err","generateToken","payload","sign","expiresIn","MagicLoginStrategy","_options","req","res","body","destination","status","send","code","Math","floor","random","sendMagicLink","callbackUrl","then","json","success","error","console","warn","redirect","query","authenticate","self","verifyCallback","user","info","fail"],"mappings":"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"}